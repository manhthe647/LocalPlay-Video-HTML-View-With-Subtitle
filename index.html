<!DOCTYPE html><html lang="vi"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>LocalPlay - Video & HTML Viewer with Advanced Subtitle Support</title><style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:Arial,sans-serif;background:#1a1a1a;color:#fff;height:100vh;display:flex}.sidebar{width:300px;background:#2a2a2a;border-right:1px solid #444;display:flex;flex-direction:column}.sidebar-header{padding:15px;background:#333;border-bottom:1px solid #444}.sidebar-header h3{margin-bottom:10px}.folder-btn{width:100%;padding:10px;background:#4a4a4a;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:14px;margin-bottom:8px}.folder-btn:hover{background:#555}.playlist{flex:1;overflow-y:auto;padding:10px}.html-item,.video-item{padding:12px;margin-bottom:8px;background:#333;border-radius:4px;cursor:pointer;border-left:3px solid transparent;position:relative}.html-item:hover,.video-item:hover{background:#3a3a3a}.html-item.active,.video-item.active{background:#404040;border-left-color:#4a9eff}.html-item{border-left-color:#ff9d4a}.html-item.active{border-left-color:#ff7a1a}.item-name{font-size:14px;margin-bottom:4px}.item-subs,.item-type{font-size:11px;color:#aaa}.main-content{flex:1;display:flex;flex-direction:column}.content-container{flex:1;display:flex;align-items:center;justify-content:center;background:#000;position:relative;overflow:auto}video{max-width:100%;max-height:100%}.html-viewer{width:100%;height:100%;border:none;background:#fff}.subtitle-display{position:absolute;bottom:80px;left:50%;transform:translateX(-50%);text-align:center;pointer-events:none;max-width:90%;padding:8px 16px;background:rgba(0,0,0,.7);border-radius:4px;line-height:1.4;z-index:10}.content-container:fullscreen .subtitle-display{position:fixed;bottom:100px;z-index:2147483647}.content-container:-webkit-full-screen .subtitle-display{position:fixed;bottom:100px;z-index:2147483647}.content-container:-moz-full-screen .subtitle-display{position:fixed;bottom:100px;z-index:2147483647}.content-container:-ms-fullscreen .subtitle-display{position:fixed;bottom:100px;z-index:2147483647}.controls-panel{background:#2a2a2a;padding:15px;border-top:1px solid #444}.control-row{display:flex;gap:15px;margin-bottom:10px;align-items:center;flex-wrap:wrap}.control-row:last-child{margin-bottom:0}.control-group{display:flex;align-items:center;gap:8px}.control-group label{font-size:13px;color:#ccc;min-width:80px}input[type=color],input[type=number]{padding:6px;background:#3a3a3a;border:1px solid #555;border-radius:3px;color:#fff}input[type=number]{width:70px}input[type=color]{width:50px;height:30px;cursor:pointer}select{padding:6px;background:#3a3a3a;border:1px solid #555;border-radius:3px;color:#fff;cursor:pointer}::-webkit-scrollbar{width:8px}::-webkit-scrollbar-track{background:#2a2a2a}::-webkit-scrollbar-thumb{background:#555;border-radius:4px}::-webkit-scrollbar-thumb:hover{background:#666}.empty-state{text-align:center;padding:40px 20px;color:#666}.hidden{display:none}.item-badge{display:inline-block;padding:2px 6px;background:#ff9d4a;color:#000;border-radius:3px;font-size:10px;font-weight:700;margin-left:5px}.last-folder-info{background:#3a3a3a;padding:8px;border-radius:4px;margin-bottom:10px}.warning-banner{background:#ff9d4a;color:#000;padding:10px;border-radius:4px;margin-bottom:10px;font-size:12px;font-weight:700}</style></head><body><div class="sidebar"><div class="sidebar-header"><h3>Danh s√°ch n·ªôi dung / Content List</h3><div id="lastFolderInfo" class="last-folder-info" style="display:none"><p style="font-size:12px;color:#aaa;margin-bottom:0">Th∆∞ m·ª•c tr∆∞·ªõc / Last folder:<strong id="lastFolderName"></strong></p></div><input type="file" id="folderInput" webkitdirectory directory multiple="multiple" style="display:none"><button class="folder-btn" id="folderBtn">üìÅ Ch·ªçn th∆∞ m·ª•c / Select Folder</button></div><div class="playlist" id="playlist"><div class="empty-state">Ch·ªçn th∆∞ m·ª•c video/HTML<br>Select video/HTML folder</div></div></div><div class="main-content"><div class="content-container" id="contentContainer"><video id="videoPlayer" controls class="hidden"></video><iframe id="htmlViewer" class="html-viewer hidden"></iframe><div class="subtitle-display" id="subtitleDisplay"></div></div><div class="controls-panel"><div class="control-row"><div class="control-group"><label>Ph·ª• ƒë·ªÅ / Subtitle:</label><select id="subtitleSelect" style="min-width:200px"><option value="">Kh√¥ng c√≥ ph·ª• ƒë·ªÅ / No subtitle</option></select></div><div class="control-group"><label>ƒê·ªô tr·ªÖ / Delay (s):</label><input type="number" id="subtitleDelay" value="0" step="0.1"></div></div><div class="control-row"><div class="control-group"><label>C·ª° ch·ªØ / Font size:</label><input type="number" id="fontSize" value="24" min="12" max="60"><span style="color:#aaa;font-size:12px">px</span></div><div class="control-group"><label>M√†u ch·ªØ / Color:</label><input type="color" id="fontColor" value="#ffffff"></div><div class="control-group"><label>Vi·ªÅn ch·ªØ / Shadow:</label><select id="textShadow"><option value="2px 2px 4px rgba(0,0,0,0.9)">ƒêen ƒë·∫≠m / Dark</option><option value="2px 2px 4px rgba(0,0,0,0.6)">ƒêen v·ª´a / Medium</option><option value="2px 2px 4px rgba(0,0,0,0.3)">ƒêen nh·∫°t / Light</option><option value="none">Kh√¥ng vi·ªÅn / None</option></select></div></div></div></div><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script><script>let items = [];
        let subtitles = [];
        let subtitleDelay = 0;
        let currentItemIndex = -1;
        let allSubtitleFiles = [];
        let fileHandles = {}; // Store file handles for reloading
        let directoryHandle = null;

        $(document).ready(function() {
            initializeApp();
        });

        async function initializeApp() {
            // Load saved data
            await loadSavedData();

            // Initialize subtitle style
            updateSubtitleStyle();

            // Event handlers
            $('#folderBtn').on('click', function() {
                $('#folderInput').click();
            });

            $('#folderInput').on('change', function(e) {
                const files = Array.from(e.target.files);
                
                // Save folder path
                if (files.length > 0) {
                    const firstFile = files[0];
                    if (firstFile.webkitRelativePath) {
                        const folderPath = firstFile.webkitRelativePath.split('/')[0];
                        localStorage.setItem('lastFolderPath', folderPath);
                        $('#lastFolderName').text(folderPath);
                        $('#lastFolderInfo').show();
                    }
                }
                
                processFiles(files);
            });

            $('#subtitleSelect').on('change', async function() {
                const selectedFile = $(this).val();
                if (selectedFile && currentItemIndex >= 0) {
                    const item = items[currentItemIndex];
                    const subtitleInfo = item.subtitleFiles?.find(f => f.name === selectedFile);
                    if (subtitleInfo) {
                        await loadSubtitle(subtitleInfo);
                    }
                } else {
                    subtitles = [];
                    $('#subtitleDisplay').text('');
                }
            });

            $('#subtitleDelay').on('change', function() {
                subtitleDelay = parseFloat($(this).val());
            });

            $('#fontSize, #fontColor, #textShadow').on('change', updateSubtitleStyle);

            $('#videoPlayer').on('timeupdate', function() {
                const currentTime = this.currentTime + subtitleDelay;
                let currentSubtitle = '';

                for (let i = 0; i < subtitles.length; i++) {
                    if (currentTime >= subtitles[i].start && currentTime <= subtitles[i].end) {
                        currentSubtitle = subtitles[i].text;
                        break;
                    }
                }

                $('#subtitleDisplay').text(currentSubtitle);
            });

            $('#videoPlayer').on('ended', function() {
                if (currentItemIndex < items.length - 1) {
                    playItem(currentItemIndex + 1);
                }
            });
        }

        async function loadSavedData() {
            const savedItems = localStorage.getItem('videoPlayerItems');
            const lastFolder = localStorage.getItem('lastFolderPath');

            if (lastFolder) {
                $('#lastFolderName').text(lastFolder);
                $('#lastFolderInfo').show();
            }

            if (savedItems) {
                try {
                    items = JSON.parse(savedItems);
                    
                    // Restore allSubtitleFiles
                    allSubtitleFiles = [];
                    items.forEach(item => {
                        if (item.subtitleFiles) {
                            item.subtitleFiles.forEach(sub => {
                                if (!allSubtitleFiles.find(f => f.name === sub.name)) {
                                    allSubtitleFiles.push(sub);
                                }
                            });
                        }
                    });

                    renderPlaylist();
                    
                    // Show warning to reload folder
                    if (items.length > 0) {
                        $('.playlist').prepend(`
                            <div class="warning-banner">
                                ‚ö†Ô∏è Vui l√≤ng ch·ªçn l·∫°i th∆∞ m·ª•c ƒë·ªÉ load video<br>
                                Please reselect folder to load videos
                            </div>
                        `);
                    }
                } catch (e) {
                    console.error('Error loading saved data:', e);
                }
            }
        }

        function saveData() {
            try {
                localStorage.setItem('videoPlayerItems', JSON.stringify(items));
            } catch (e) {
                console.error('Error saving data:', e);
            }
        }

        async function processFiles(files) {
            // Remove warning banner
            $('.warning-banner').remove();

            const videoFiles = files.filter(f => /\.(mp4|mkv|avi|webm|mov)$/i.test(f.name));
            const htmlFiles = files.filter(f => /\.(html|htm)$/i.test(f.name));
            const srtFiles = files.filter(f => /\.(srt|vtt)$/i.test(f.name));

            // Store files in memory
            fileHandles = {};
            files.forEach(file => {
                fileHandles[file.name] = file;
            });

            // Store subtitle file info
            allSubtitleFiles = srtFiles.map(srt => ({ 
                name: srt.name 
            }));

            // Clear old items
            items = [];

            // Process videos
            videoFiles.forEach(videoFile => {
                const baseName = videoFile.name.replace(/\.[^/.]+$/, '');
                
                const matchingSubs = allSubtitleFiles.filter(f => {
                    const srtBase = f.name.replace(/\.(srt|vtt)$/i, '');
                    return srtBase.startsWith(baseName);
                });

                items.push({
                    type: 'video',
                    name: videoFile.name,
                    baseName: baseName,
                    subtitleFiles: matchingSubs
                });
            });

            // Process HTML files
            htmlFiles.forEach(htmlFile => {
                items.push({
                    type: 'html',
                    name: htmlFile.name,
                    baseName: htmlFile.name.replace(/\.[^/.]+$/, '')
                });
            });

            // Sort by name
            items.sort((a, b) => a.name.localeCompare(b.name));
            
            saveData();
            renderPlaylist();

            // Auto play first item
            if (items.length > 0) {
                await playItem(0);
            }
        }

        function renderPlaylist() {
            const $playlist = $('#playlist');
            
            // Keep warning banner if exists
            const $warning = $('.warning-banner');
            
            if (items.length === 0) {
                $playlist.html('<div class="empty-state">Ch·ªçn th∆∞ m·ª•c video/HTML<br>Select video/HTML folder</div>');
                return;
            }

            $playlist.empty();
            
            // Re-add warning if it existed
            if ($warning.length > 0) {
                $playlist.append($warning);
            }
            
            items.forEach((item, index) => {
                const $div = $('<div>')
                    .addClass(item.type === 'html' ? 'html-item' : 'video-item')
                    .toggleClass('active', index === currentItemIndex);
                
                let subsInfo = '';
                if (item.type === 'video') {
                    const subCount = item.subtitleFiles ? item.subtitleFiles.length : 0;
                    subsInfo = subCount > 0 ? `${subCount} ph·ª• ƒë·ªÅ / subtitle${subCount > 1 ? 's' : ''}` : 'Kh√¥ng c√≥ ph·ª• ƒë·ªÅ / No subtitle';
                } else {
                    subsInfo = 'HTML Document';
                }
                
                $div.html(`
                    <div class="item-name">
                        ${item.baseName}
                        ${item.type === 'html' ? '<span class="item-badge">HTML</span>' : ''}
                    </div>
                    <div class="item-${item.type === 'html' ? 'type' : 'subs'}">${subsInfo}</div>
                `);
                
                $div.on('click', function() {
                    playItem(index);
                });
                
                $playlist.append($div);
            });
        }

        async function playItem(index) {
            currentItemIndex = index;
            const item = items[index];
            
            const file = fileHandles[item.name];
            
            if (!file) {
                alert('File kh√¥ng t√¨m th·∫•y. Vui l√≤ng ch·ªçn l·∫°i th∆∞ m·ª•c.\nFile not found. Please reselect folder.');
                return;
            }
            
            if (item.type === 'video') {
                $('#videoPlayer').removeClass('hidden');
                $('#htmlViewer').addClass('hidden');
                $('#subtitleDisplay').removeClass('hidden');
                
                const url = URL.createObjectURL(file);
                $('#videoPlayer').attr('src', url);
                
                await updateSubtitleSelect(item);
            } else if (item.type === 'html') {
                $('#videoPlayer').addClass('hidden');
                $('#htmlViewer').removeClass('hidden');
                $('#subtitleDisplay').addClass('hidden');
                
                const url = URL.createObjectURL(file);
                $('#htmlViewer').attr('src', url);
                
                subtitles = [];
                $('#subtitleSelect').html('<option value="">Kh√¥ng c√≥ ph·ª• ƒë·ªÅ / No subtitle</option>');
            }
            
            renderPlaylist();
        }

        async function updateSubtitleSelect(item) {
            const $select = $('#subtitleSelect');
            $select.empty();
            $select.append('<option value="">Kh√¥ng c√≥ ph·ª• ƒë·ªÅ / No subtitle</option>');
            
            if (item.subtitleFiles && item.subtitleFiles.length > 0) {
                item.subtitleFiles.forEach(subFile => {
                    $select.append(`<option value="${subFile.name}">${subFile.name}</option>`);
                });
                
                // Auto select first subtitle
                $select.val(item.subtitleFiles[0].name);
                await loadSubtitle(item.subtitleFiles[0]);
            } else {
                subtitles = [];
            }
        }

        async function loadSubtitle(subFileInfo) {
            const file = fileHandles[subFileInfo.name];
            
            if (!file) {
                console.error('Subtitle file not found:', subFileInfo.name);
                return;
            }
            
            try {
                const content = await file.text();
                
                if (subFileInfo.name.endsWith('.vtt')) {
                    parseVTT(content);
                } else {
                    parseSRT(content);
                }
            } catch (error) {
                console.error('Error loading subtitle:', error);
            }
        }

        function parseSRT(srtContent) {
            subtitles = [];
            const blocks = srtContent.trim().split(/\n\s*\n/);

            blocks.forEach(block => {
                const lines = block.split('\n');
                if (lines.length >= 3) {
                    const timeMatch = lines[1].match(/(\d{2}):(\d{2}):(\d{2})[,.](\d{3})\s*-->\s*(\d{2}):(\d{2}):(\d{2})[,.](\d{3})/);
                    
                    if (timeMatch) {
                        const startTime = parseTime(timeMatch[1], timeMatch[2], timeMatch[3], timeMatch[4]);
                        const endTime = parseTime(timeMatch[5], timeMatch[6], timeMatch[7], timeMatch[8]);
                        const text = lines.slice(2).join('\n').replace(/<[^>]*>/g, '');

                        subtitles.push({
                            start: startTime,
                            end: endTime,
                            text: text
                        });
                    }
                }
            });
        }

        function parseVTT(vttContent) {
            subtitles = [];
            const lines = vttContent.split('\n');
            let i = 0;
            
            // Skip header
            while (i < lines.length && !lines[i].includes('-->')) {
                i++;
            }
            
            while (i < lines.length) {
                const timeMatch = lines[i].match(/(\d{2}):(\d{2}):(\d{2})[,.](\d{3})\s*-->\s*(\d{2}):(\d{2}):(\d{2})[,.](\d{3})/);
                
                if (timeMatch) {
                    const startTime = parseTime(timeMatch[1], timeMatch[2], timeMatch[3], timeMatch[4]);
                    const endTime = parseTime(timeMatch[5], timeMatch[6], timeMatch[7], timeMatch[8]);
                    
                    i++;
                    let text = '';
                    while (i < lines.length && lines[i].trim() !== '' && !lines[i].includes('-->')) {
                        text += lines[i] + '\n';
                        i++;
                    }
                    
                    text = text.trim().replace(/<[^>]*>/g, '');
                    
                    if (text) {
                        subtitles.push({
                            start: startTime,
                            end: endTime,
                            text: text
                        });
                    }
                }
                i++;
            }
        }

        function parseTime(hours, minutes, seconds, milliseconds) {
            return parseInt(hours) * 3600 + 
                   parseInt(minutes) * 60 + 
                   parseInt(seconds) + 
                   parseInt(milliseconds) / 1000;
        }

        function updateSubtitleStyle() {
            const fontSize = $('#fontSize').val();
            const fontColor = $('#fontColor').val();
            const textShadow = $('#textShadow').val();

            $('#subtitleDisplay').css({
                fontSize: fontSize + 'px',
                color: fontColor,
                textShadow: textShadow
            });
        }</script></body></html>